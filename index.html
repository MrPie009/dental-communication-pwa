<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dental Patient Communication</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- iOS specific PWA settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Dental Comm">
    <link rel="apple-touch-icon" href="/icons/icon-152x152.png">
    
    <!-- Theme colors -->
    <meta name="theme-color" content="#21808d">
    <meta name="msapplication-TileColor" content="#21808d">
    <meta name="msapplication-TileImage" content="/icons/icon-144x144.png">
    
    <!-- Preload critical resources -->
    <link rel="preload" href="/style.css" as="style">
    <link rel="preload" href="/app.js" as="script">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/icon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/icon-16x16.png">
    
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- PWA Install Banner (hidden by default) -->
    <div id="pwa-install-banner" class="pwa-banner hidden">
        <div class="pwa-banner-content">
            <div class="pwa-banner-icon">üì±</div>
            <div class="pwa-banner-text">
                <h3>Install Dental Communication App</h3>
                <p>Add to home screen for quick access during procedures</p>
            </div>
            <div class="pwa-banner-actions">
                <button id="pwa-install-btn" class="btn btn--primary btn--sm">Install</button>
                <button id="pwa-dismiss-btn" class="btn btn--outline btn--sm">Not Now</button>
            </div>
        </div>
    </div>
    
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <h1>Patient Communication</h1>
            <div class="header-controls">
                <button id="adminToggle" class="btn btn--secondary">Admin Mode</button>
                <button id="instructionsToggle" class="btn btn--outline btn--sm">Instructions</button>
                <button id="volumeTest" class="btn btn--outline btn--sm">Test Volume</button>
                <div id="pwa-status" class="pwa-status">
                    <span id="connection-status" class="status-online">‚óè</span>
                </div>
            </div>
        </header>

        <!-- Instructions Panel -->
        <div id="instructionsPanel" class="instructions-panel hidden">
            <div class="card">
                <div class="card__body">
                    <h3>How to Use</h3>
                    <ul class="instructions-list">
                        <li>Use arrow keys to navigate between options</li>
                        <li>Press Enter or Space to select an option</li>
                        <li>Selected option will be spoken aloud</li>
                        <li>Dentist can customize responses in Admin Mode</li>
                        <li><strong>PWA:</strong> Add to home screen for offline access</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Response Grid -->
        <main class="response-container">
            <div id="responseGrid" class="response-grid">
                <!-- Response buttons will be generated dynamically -->
            </div>
        </main>

        <!-- Status Display -->
        <div id="statusDisplay" class="status-display">
            <p id="statusMessage">Use arrow keys to navigate, Enter to select</p>
        </div>

        <!-- Admin Panel -->
        <div id="adminPanel" class="admin-panel hidden">
            <div class="card">
                <div class="card__header">
                    <h3>Admin Mode - Customize Responses</h3>
                    <button id="adminClose" class="btn btn--outline btn--sm">Exit Admin</button>
                </div>
                <div class="card__body">
                    <div class="admin-controls">
                        <div class="form-group">
                            <label for="newResponseText">Add New Response:</label>
                            <div class="input-group">
                                <input type="text" id="newResponseText" placeholder="Enter response text" maxlength="50">
                                <button id="addResponse" class="btn btn--primary">Add</button>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Current Responses:</label>
                            <div id="responseList" class="response-list">
                                <!-- Response items will be generated dynamically -->
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="speechRate">Speech Settings:</label>
                            <div class="speech-controls">
                                <div class="slider-group">
                                    <label for="speechRate">Speed:</label>
                                    <input type="range" id="speechRate" min="0.5" max="2" step="0.1" value="1">
                                    <span id="speechRateValue">1.0</span>
                                </div>
                                <div class="slider-group">
                                    <label for="speechVolume">Volume:</label>
                                    <input type="range" id="speechVolume" min="0" max="1" step="0.1" value="1">
                                    <span id="speechVolumeValue">1.0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- PWA Update Available Toast -->
    <div id="update-toast" class="update-toast hidden">
        <div class="toast-content">
            <span>New version available!</span>
            <button id="update-btn" class="btn btn--primary btn--sm">Update</button>
            <button id="update-dismiss" class="btn btn--outline btn--sm">Later</button>
        </div>
    </div>

    <script src="app.js"></script>
    
    <!-- PWA Service Worker Registration -->
    <script>
        // Register service worker for PWA functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('/sw.js');
                    console.log('Service Worker registered:', registration);
                    
                    // Handle service worker updates
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                // Show update notification
                                showUpdateToast();
                            }
                        });
                    });
                } catch (error) {
                    console.error('Service Worker registration failed:', error);
                }
            });
        }
        
        // PWA install prompt handling
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('PWA install prompt triggered');
            e.preventDefault();
            deferredPrompt = e;
            showPWABanner();
        });
        
        // Show PWA install banner
        function showPWABanner() {
            const banner = document.getElementById('pwa-install-banner');
            if (banner) {
                banner.classList.remove('hidden');
                
                document.getElementById('pwa-install-btn').addEventListener('click', async () => {
                    if (deferredPrompt) {
                        deferredPrompt.prompt();
                        const result = await deferredPrompt.userChoice;
                        console.log('PWA install result:', result);
                        deferredPrompt = null;
                        banner.classList.add('hidden');
                    }
                });
                
                document.getElementById('pwa-dismiss-btn').addEventListener('click', () => {
                    banner.classList.add('hidden');
                });
            }
        }
        
        // Show update toast
        function showUpdateToast() {
            const toast = document.getElementById('update-toast');
            if (toast) {
                toast.classList.remove('hidden');
                
                document.getElementById('update-btn').addEventListener('click', () => {
                    if (navigator.serviceWorker.controller) {
                        navigator.serviceWorker.controller.postMessage({action: 'skipWaiting'});
                    }
                    window.location.reload();
                });
                
                document.getElementById('update-dismiss').addEventListener('click', () => {
                    toast.classList.add('hidden');
                });
            }
        }
        
        // Connection status monitoring
        function updateConnectionStatus() {
            const statusEl = document.getElementById('connection-status');
            if (statusEl) {
                if (navigator.onLine) {
                    statusEl.className = 'status-online';
                    statusEl.title = 'Online';
                } else {
                    statusEl.className = 'status-offline';
                    statusEl.title = 'Offline - Limited functionality';
                }
            }
        }
        
        window.addEventListener('online', updateConnectionStatus);
        window.addEventListener('offline', updateConnectionStatus);
        window.addEventListener('load', updateConnectionStatus);
        
        // PWA install success tracking
        window.addEventListener('appinstalled', () => {
            console.log('PWA was installed');
            // Hide install banner if showing
            const banner = document.getElementById('pwa-install-banner');
            if (banner) {
                banner.classList.add('hidden');
            }
        });
    </script>
</body>
</html>
